name: Build and Upload Binaries

on:
  release:
    types: [published]  # triggers when a new release is published (semantic-release or manual)

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        os: [macos-latest, ubuntu-latest]

    steps:
      # 1️⃣ Checkout your repo
      - name: Checkout code
        uses: actions/checkout@v4

      # 2️⃣ Set up Rust
      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
            toolchain: stable
            override: true

      # 3️⃣ Build release binary
      - name: Build release
        run: cargo build --release

      # 4️⃣ Prepare artifact directory
      - name: Prepare release artifacts
        run: |
          mkdir -p release
          BIN_NAME="rusty-chess"
          if [[ "${{ matrix.os }}" == "macos-latest" ]]; then
            TAR_NAME="rusty-chess-${GITHUB_REF_NAME}-x86_64-apple-darwin.tar.gz"
          else
            TAR_NAME="rusty-chess-${GITHUB_REF_NAME}-x86_64-unknown-linux-gnu.tar.gz"
          fi
          cp target/release/$BIN_NAME release/
          tar -czf $TAR_NAME -C release $BIN_NAME
          sha256sum $TAR_NAME | awk '{print $1}' > $TAR_NAME.sha256
          echo "Built $TAR_NAME with SHA256 $(cat $TAR_NAME.sha256)"

      # 5️⃣ Upload binaries to GitHub Release
      - name: Upload release assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            rusty-chess-${GITHUB_REF_NAME}-x86_64-apple-darwin.tar.gz
            rusty-chess-${GITHUB_REF_NAME}-x86_64-apple-darwin.tar.gz.sha256
            rusty-chess-${GITHUB_REF_NAME}-x86_64-unknown-linux-gnu.tar.gz
            rusty-chess-${GITHUB_REF_NAME}-x86_64-unknown-linux-gnu.tar.gz.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
